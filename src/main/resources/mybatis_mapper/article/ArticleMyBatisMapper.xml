<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hn369.universeblog.infra.repository.article.ArticleMyBatisMapper">

    <resultMap id="ArticleMapper" type="com.hn369.universeblog.dto.article.ArticleReadResponseDto">
        <id property="articleUuid" column="article_uuid"/>
        <result property="articleName" column="article_name"/>
        <result property="articleContent" column="article_content"/>
        <result property="createdUser" column="created_user"/>
        <result property="updatedUser" column="updated_user"/>
        <result property="createdUser" column="created_user"/>
        <result property="masterTopic" column="topic_name"/>
        <result property="masterTopicUuid" column="topic_uuid"/>
        <result property="serialArticle" column="serial_article_uuid"/>
        <result property="languageCode" column="language_code"/>
        <result property="languageName" column="language_name"/>
        <result property="viewCounter" column="view_counter"/>
        <result property="sourceReference" column="source_reference"/>
        <result property="dateCreated" column="date_created"/>
        <result property="dateUpdated" column="date_updated"/>
        <result property="chapterId" column="chapter_id"/>
    </resultMap>

	<select id="findSingleArticlesByTopicAndLanguage" resultMap="ArticleMapper">
	    SELECT 
	        at.article_uuid, 
	        at.article_name, 
	        at.article_content, 
	        at.created_user, 
	        at.updated_user, 
	        at.serial_article_uuid, 
	        tt.topic_name, 
	        tt.topic_uuid, 
	        l.language_code, 
	        l.language_name,
	        a.view_counter,
	        -- Priority for language matching (exact match first)
	        CASE 
	            WHEN at.language_code = #{languageCode} THEN 1 
	            ELSE 2 
	        END AS language_priority
	    FROM article a 
	    JOIN article_translation at ON a.article_uuid = at.article_uuid
	    JOIN article_topic atp ON a.article_uuid = atp.article_uuid
	    JOIN topic t ON t.topic_uuid = atp.topic_uuid
	    JOIN topic_translation tt ON t.topic_uuid = tt.topic_uuid
	    JOIN language l ON at.language_code = l.language_code
	    WHERE atp.topic_uuid = #{topicUuid}
	    AND atp.matter_topic = true
	    AND at.language_code IN ('int', #{languageCode})
	    AND tt.language_code IN ('int', #{languageCode})
	    AND at.serial_article_uuid IS NULL
	    ORDER BY 
	        language_priority ASC,  -- Exact language matches first
	        a.view_counter DESC,    -- Then by popularity
	        at.date_updated DESC    -- Then by recency
	    <if test="quantity != null and quantity > 0">
	        LIMIT #{quantity}
	    </if>
	</select>
    
	<select id="retrieveHotArticles" resultMap="ArticleMapper">
		select at.article_uuid, at.article_name, at.article_content, at.created_user, 
			   at.updated_user, at.serial_article_uuid, tt.topic_name, tt.topic_uuid, l.language_code, l.language_name,
			   a.view_counter
		from article a join article_translation at on a.article_uuid = at.article_uuid
			  join article_topic atp on a.article_uuid = atp.article_uuid
			  join topic t on t.topic_uuid = atp.topic_uuid
			  join topic_translation tt on t.topic_uuid = tt.topic_uuid
			  join language l on at.language_code = l.language_code
		where atp.matter_topic = true
			  and at.language_code in ('int', #{languageCode})
			  and tt.language_code in ('int', #{languageCode})
	    order by a.view_counter desc
	    limit #{quantity}
    </select>

	<select id="retrieveArticleByUuidAndLanguage" resultMap="ArticleMapper">
		select article_uuid, article_name, article_content,  date_created, date_updated, serial_article_uuid,
			   created_user, updated_user, source_reference, chapter_id, l.language_code, l.language_name
		from article_translation at join language l on at.language_code = l.language_code
		where article_uuid = #{articleUuid} and at.language_code in (#{languageCode}, 'int')
    </select>
    
    <select id="findBySerialArticleAndChapterIdAndLanguage" resultMap="ArticleMapper">
		select article_uuid, article_name, article_content,  date_created, date_updated, serial_article_uuid,
			   created_user, updated_user, source_reference, chapter_id, l.language_code, l.language_name
		from article_translation at join language l on at.language_code = l.language_code
		where serial_article_uuid = #{serialArticleUuid} and at.language_code in (#{languageCode}, 'int')
			  and chapter_id = #{chapterId}
    </select>
    
	<select id="retrieveAllChaptersOfASerialArticle" resultMap="ArticleMapper">
	    SELECT at.article_uuid, at.article_name, at.created_user, 
	           at.updated_user, at.date_created, at.date_updated,
	           at.chapter_id, at.serial_article_uuid, a.view_counter
	    FROM article a 
	         JOIN article_translation at ON a.article_uuid = at.article_uuid
	         JOIN serial_article sa ON at.serial_article_uuid = sa.serial_article_uuid
	    WHERE sa.serial_article_uuid = #{serialArticleUuid}
	          AND language_code = #{languageCode}
	    ORDER BY at.chapter_id
	    LIMIT #{size} OFFSET #{offset}   <!-- Pagination clause -->
	</select>

</mapper>