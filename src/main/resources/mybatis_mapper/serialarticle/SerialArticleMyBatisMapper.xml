<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hn369.universeblog.infra.repository.serialarticle.SerialArticleMyBatisMapper">

    <resultMap id="SerialArticleResultMap" type="com.hn369.universeblog.dto.serialarticle.SerialArticleReadResponseDto">
        <id property="serialArticleUuid" column="serial_article_uuid"/>
        <result property="serialArticleName" column="serial_article_name"/>
        <result property="languageCode" column="language_code"/>
        <result property="default_language_code" column="defaultLanguageCode"/>
    </resultMap>

    <select id="findSerialArticleByMasterTopicUuidAndLanguage" resultMap="SerialArticleResultMap">
		select sat.serial_article_uuid, sat.serial_article_name, sat.language_code
		from serial_article sa join serial_article_translation sat on sa.serial_article_uuid = sat.serial_article_uuid
							   join serial_article_topic satp on sa.serial_article_uuid = satp.serial_article_uuid
		where sat.language_code = #{languageCode} and satp.topic_uuid = #{masterTopicUuid}
    </select>
    <select id="findSerialArticleByUuidAndLanguage" resultMap="SerialArticleResultMap">
		select sat.serial_article_uuid, sat.serial_article_name, sat.language_code
		from serial_article sa join serial_article_translation sat on sa.serial_article_uuid = sat.serial_article_uuid
		where sat.language_code = #{languageCode} and sat.serial_article_uuid = #{serialArticleUuid}
    </select>
    
    <!-- For Admin to create the master chapter (master serial article) -->
    <select id="findAllSerialArticles" resultMap="SerialArticleResultMap">
		select sa.serial_article_uuid, sa.serial_article_name, sa.default_language_code
		from serial_article sa
    </select>
    
    <resultMap id="SerialArticleMasterSearchMapper"
               type="com.hn369.universeblog.dto.serialarticle.SerialArticleMasterSearchResponseDto">
        <result property="serialArticleUuid" column="serial_article_uuid"/>
        <result property="serialArticleName" column="serial_article_name"/>
        <result property="defaultLanguageCode" column="default_language_code"/>
        <result property="topicUuid" column="topic_uuid"/>
        <result property="topicName" column="topic_name"/>
    </resultMap>

    <select id="searchSerialArticleMaster"
            parameterType="com.hn369.universeblog.dto.serialarticle.SerialArticleMasterSearchRequestDto"
            resultMap="SerialArticleMasterSearchMapper">

        SELECT 
            sa.serial_article_uuid,
            sa.serial_article_name,
            sa.default_language_code,
            t.topic_uuid,
            t.topic_name
        FROM serial_article sa
        LEFT JOIN serial_article_topic sat ON sa.serial_article_uuid = sat.serial_article_uuid
        LEFT JOIN topic t ON sat.topic_uuid = t.topic_uuid
        WHERE 1=1

        <if test="serialArticleName != null and serialArticleName != ''">
            AND LOWER(sa.serial_article_name) LIKE LOWER(CONCAT('%', #{serialArticleName}, '%'))
        </if>

        <if test="defaultLanguageCode != null and defaultLanguageCode != ''">
            AND sa.default_language_code = #{defaultLanguageCode}
        </if>

        <if test="topicName != null and topicName != ''">
            AND LOWER(t.topic_name) LIKE LOWER(CONCAT('%', #{topicName}, '%'))
        </if>

        ORDER BY sa.serial_article_name ASC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countSerialArticles"
            parameterType="com.hn369.universeblog.dto.serialarticle.SerialArticleMasterSearchRequestDto"
            resultType="long">

        SELECT COUNT(DISTINCT sa.serial_article_uuid)
        FROM serial_article sa
        LEFT JOIN serial_article_topic sat ON sa.serial_article_uuid = sat.serial_article_uuid
        LEFT JOIN topic t ON sat.topic_uuid = t.topic_uuid
        WHERE 1=1

        <if test="serialArticleName != null and serialArticleName != ''">
            AND LOWER(sa.serial_article_name) LIKE LOWER(CONCAT('%', #{serialArticleName}, '%'))
        </if>

        <if test="defaultLanguageCode != null and defaultLanguageCode != ''">
            AND sa.default_language_code = #{defaultLanguageCode}
        </if>

        <if test="topicName != null and topicName != ''">
            AND LOWER(t.topic_name) LIKE LOWER(CONCAT('%', #{topicName}, '%'))
        </if>
    </select>    

</mapper>